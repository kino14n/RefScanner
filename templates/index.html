<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>RefScanner</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; }
    textarea { width: 100%; height: 100px; }
    button { padding: 0.5rem 1rem; margin-top: 0.5rem; }
    .loading { font-style: italic; color: #555; margin-top: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
  </style>
</head>
<body>
  <h1>üîç RefScanner</h1>
  <p>Introduce c√≥digos <strong>separados por comas</strong> o <strong>uno por l√≠nea</strong>:</p>
  <textarea id="codes" placeholder="Ejemplo:&#10;173H-1&#10;C9009L, D-1234"></textarea>
  <br>
  <button id="btn">Buscar</button>
  <div id="output"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üõ† RefScanner JS cargado');
      const btn = document.getElementById('btn');
      const out = document.getElementById('output');

      btn.addEventListener('click', async e => {
        e.preventDefault();
        const raw = document.getElementById('codes').value;

        // Separa por comas o saltos de l√≠nea
        const codes = raw
          .split(/[\n,]+/)
          .map(s => s.trim())
          .filter(Boolean);

        if (!codes.length) {
          out.innerHTML = '<span class="loading">‚ö†Ô∏è Ingresa al menos un c√≥digo.</span>';
          return;
        }

        out.innerHTML = '<span class="loading">‚åõ Buscando...</span>';

        try {
          const resp = await fetch(`${window.location.origin}/search`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codes })
          });
          const data = await resp.json();

          // Si no hay resultados
          if (!Object.keys(data).length) {
            out.innerHTML = '<span class="loading">‚ö†Ô∏è No se encontr√≥ ning√∫n c√≥digo.</span>';
            return;
          }

          // Construye la tabla con columna P√°gina
          let html = `
            <table>
              <tr>
                <th>C√≥digo</th>
                <th>Manifiesto</th>
                <th>Link</th>
                <th>Veces</th>
                <th>P√°gina</th>
              </tr>
          `;
          for (let term of Object.keys(data)) {
            const items = data[term];
            if (items.length === 0) {
              html += `
                <tr>
                  <td colspan="5">No se encontr√≥ ‚Äú${term}‚Äù.</td>
                </tr>`;
            } else {
              items.forEach(item => {
                html += `
                  <tr>
                    <td>${item.code}</td>
                    <td>${item.manifesto}</td>
                    <td><a href="${item.link}" target="_blank">Abrir PDF</a></td>
                    <td>${item.occurrences}</td>
                    <td>${item.page}</td>
                  </tr>`;
              });
            }
          }
          html += '</table>';
          out.innerHTML = html;

        } catch (err) {
          console.error('üî• Error en fetch:', err);
          out.innerHTML = '<span class="loading">‚ùå Error al buscar. Mira la consola.</span>';
        }
      });
    });
  </script>
</body>
</html>
